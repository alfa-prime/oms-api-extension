# Обзор продукта

Это система интеграции медицинских данных, которая связывает ЕВМИАС (Единая ведомственная медицинская информационно-аналитическая система) и ГИС ОМС (Государственная информационная система обязательного медицинского страхования).

## Основной функционал
- **Браузерное расширение**: Chrome расширение, работающее с формами ГИС ОМС
- **FastAPI бэкенд**: Обрабатывает аутентификацию, получение и обработку данных из ЕВМИАС
- **Маппинг данных**: Преобразует медицинские данные между различными форматами систем
- **Автозаполнение форм**: Автоматически заполняет формы ГИС ОМС данными пациентов

## Ключевые компоненты
- Поиск пациентов по ФИО
- Получение данных медицинских организаций
- Маппинг типов оплаты и кодов отделений
- Управление сессиями с кэшированием в Redis
- API с поддержкой CORS для связи с браузерным расширением

## Целевые пользователи
Медицинские работники, работающие с системами ЕВМИАС и ГИС ОМС, которым необходимо эффективно передавать данные пациентов.


# Технологический стек

## Бэкенд
- **Фреймворк**: FastAPI с паттернами async/await
- **Версия Python**: Современный Python (3.8+)
- **HTTP клиент**: httpx для внешних API вызовов
- **Конфигурация**: pydantic-settings для настроек на основе переменных окружения
- **Логирование**: loguru для структурированного логирования
- **Кэширование**: Redis для управления сессиями
- **Сервер**: uvicorn (разработка) / gunicorn (продакшн)

## Фронтенд (Браузерное расширение)
- **Манифест**: Chrome Extension Manifest V3
- **JavaScript**: ES6+ модули с async/await
- **Архитектура**: Service worker фоновый скрипт + content скрипты
- **Разрешения**: activeTab, scripting, tabs, windows

## Инфраструктура
- **Контейнеризация**: Docker с многоэтапными сборками
- **Оркестрация**: Docker Compose для локальной разработки
- **База данных**: Redis для кэширования и хранения сессий
- **Окружение**: .env файлы для управления конфигурацией

## Основные библиотеки
- `fastapi` - Веб-фреймворк
- `httpx` - HTTP клиент с логикой повторов (tenacity)
- `pydantic-settings` - Управление конфигурацией
- `redis` + `hiredis` - Слой кэширования
- `loguru` - Логирование

## Основные команды

### Разработка
```bash
# Запуск среды разработки
make up

# Остановка сервисов
make down

# Доступ к shell контейнера приложения
make bash

# Просмотр логов
docker compose logs -f app
```

### Продакшн
```bash
# Развертывание продакшн
make up-prod

# Остановка продакшн
make down-prod

# Просмотр логов продакшн
make logs-prod

# Доступ к продакшн shell
make bash-prod
```

### Обслуживание
```bash
# Очистка Docker ресурсов
make clean
```

## Процесс сборки
- Docker сборки используют многоэтапный подход
- Разработка: Горячая перезагрузка с монтированием томов
- Продакшн: Оптимизированные образы без dev зависимостей
- Переменные окружения загружаются из `.env` (dev) или `.prod.env` (prod)

# Структура проекта

## Корневой уровень
- **Конфигурация**: `.env`, `.env.example`, `.prod.env` - Конфигурации окружения
- **Docker**: `Dockerfile`, `Dockerfile.prod`, `docker-compose.yml`, `docker-compose.prod.yml`
- **Сборка**: `makefile` - Общие команды разработки
- **Зависимости**: `requirements.txt` - Зависимости Python пакетов

## Бэкенд (`app/`)
```
app/
├── main.py              # Точка входа FastAPI приложения с управлением жизненным циклом
├── core/                # Основные компоненты приложения
│   ├── config.py        # Настройки и конфигурация Pydantic
│   ├── dependencies.py  # Внедрение зависимостей FastAPI
│   ├── decorators.py    # Пользовательские декораторы
│   ├── httpx_client.py  # Настройка HTTP клиента
│   ├── lifespan_services.py # Управление жизненным циклом приложения
│   └── logger_setup.py  # Конфигурация логирования
├── route/               # Определения API маршрутов
├── service/             # Сервисы бизнес-логики
│   ├── cookie/          # Управление cookies
│   ├── evmias/          # Интеграция с ЕВМИАС
│   └── extension/       # Обработчики API браузерного расширения
├── mapper/              # Преобразование и маппинг данных
│   ├── bed_profiles.py  # Маппинг профилей коек
│   ├── department_codes.py # Маппинг кодов отделений
│   ├── medical_orgs.py  # Маппинг медицинских организаций
│   └── payment_types.py # Маппинг типов оплаты
└── model/               # Модели данных и схемы
    └── extension.py     # Модели специфичные для расширения
```

## Фронтенд (`browser-extension/`)
```
browser-extension/
├── manifest.json        # Конфигурация Chrome расширения
├── index.html          # Интерфейс popup расширения
├── js/
│   ├── apiService.js   # Слой коммуникации с API
│   ├── background.js   # Service worker (фоновый скрипт)
│   ├── content.js      # Content скрипт для взаимодействия со страницей
│   ├── main.js         # Основная логика расширения
│   ├── form.js         # Утилиты манипуляции формами
│   ├── searchLogic.js  # Функциональность поиска пациентов
│   ├── ui.js           # Компоненты пользовательского интерфейса
│   ├── utils.js        # Вспомогательные функции
│   └── pageInjector.js # Логика инъекции в страницу
└── css/
    └── style.css       # Стили расширения
```

## Архитектурные паттерны

### Паттерны бэкенда
- **Слоистая архитектура**: Маршруты → Сервисы → Мапперы → Внешние API
- **Внедрение зависимостей**: Система зависимостей FastAPI для общих ресурсов
- **Async/Await**: Повсеместно для неблокирующих операций
- **Управление конфигурацией**: Централизованные настройки с переменными окружения
- **Управление жизненным циклом**: Правильная инициализация и очистка ресурсов

### Паттерны фронтенда
- **Модульный паттерн**: ES6 модули для организации кода
- **Сервисный слой**: Централизованная коммуникация с API в `apiService.js`
- **Архитектура Content Script**: Разделение взаимодействия со страницей и фоновой обработки
- **Событийно-ориентированная**: Передача сообщений между компонентами расширения

### Поток данных
1. **Расширение** → API Service → **Маршруты бэкенда**
2. **Бэкенд** → Сервис ЕВМИАС → Внешний API
3. **Мапперы** преобразуют данные между системами
4. **Redis** кэширует данные сессий и ответы

## Соглашения по именованию
- **Python**: snake_case для функций, переменных, файлов
- **JavaScript**: camelCase для функций, переменных
- **Файлы**: Описательные имена, отражающие функциональность
- **API эндпоинты**: RESTful паттерны с четким именованием ресурсов
- **Переменные окружения**: ЗАГЛАВНЫЕ с подчеркиваниями